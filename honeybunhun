import socket
import logging
from concurrent.futures import ThreadPoolExecutor

# Configure logging
logging.basicConfig(
    filename='honeypot.log', 
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

def log_connection(port, client_address, data=None):
    """Logs the connection details."""
    if data:
        logging.info("Connection on port {0} from {1} - Data: {2}".format(port, client_address, data))
    else:
        logging.info("Connection on port {0} from {1}".format(port, client_address))

def handle_client(client_socket, client_address, port):
    """Handles interaction with a client."""
    try:
        # Log the connection
        log_connection(port, client_address)

        # Simulate a response for the honeypot service
        response = "You've reached a honeypot on port {0}!".format(port)
        client_socket.send(response.encode('utf-8'))

        # Log received data (if any)
        data = client_socket.recv(1024)
        if data:
            log_connection(port, client_address, data=data)
    except Exception as e:
        logging.error("Error handling client on port {0}: {1}".format(port, e))
    finally:
        client_socket.close()

def start_honeypot(port):
    """Starts a honeypot on the specified port."""
    try:
        server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        server_socket.bind(('0.0.0.0', port))
        server_socket.listen(5)
        logging.info("Honeypot listening on port {0}".format(port))

        while True:
            client_socket, client_address = server_socket.accept()
            handle_client(client_socket, client_address, port)
    except Exception as e:
        logging.error("Error on port {0}: {1}".format(port, e))
    finally:
        server_socket.close()

if __name__ == "__main__":
    # Define the range of ports to listen on
    port_range = range(1, 1025)  # Adjust range if necessary (e.g., 1-65535)

    # Use a ThreadPoolExecutor to manage threads
    with ThreadPoolExecutor(max_workers=100) as executor:
        for port in port_range:
            executor.submit(start_honeypot, port)
